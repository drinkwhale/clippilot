openapi: 3.1.0
info:
  title: ClipPilot YouTube Search API
  description: |
    YouTube 영상 검색, 필터링, CII 계산, 자막 수집 기능을 제공하는 API

    ## 주요 기능
    - YouTube Data API v3 기반 영상 검색
    - 고급 필터링 (영상 타입, 업로드 기간, 국가, CII, 조회수, 구독자 수)
    - CII (Channel Influence Index) 계산 및 정렬
    - 자막 수집 및 다운로드
    - 템플릿으로 저장
    - 검색 히스토리 관리

    ## Rate Limiting
    - 사용자당 분당 10회 요청
    - Premium 사용자: 30회/분
    - Enterprise 사용자: 100회/분

    ## Quota Management
    - YouTube API 일일 할당량: 10,000 units
    - 캐싱으로 quota 사용 최적화

  version: 1.0.0
  contact:
    name: ClipPilot API Support
    email: support@clippilot.com

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: https://api.clippilot.com/api/v1
    description: Production server

tags:
  - name: Search
    description: YouTube 영상 검색
  - name: Videos
    description: 영상 상세 정보 및 자막
  - name: Channels
    description: 채널 정보 및 CII 계산
  - name: Templates
    description: 템플릿 저장
  - name: History
    description: 검색 히스토리

paths:
  /youtube/search:
    get:
      tags:
        - Search
      summary: YouTube 영상 검색
      description: |
        키워드로 YouTube 영상을 검색합니다.

        ## 주요 기능
        - 다양한 필터링 옵션 (영상 타입, 업로드 기간, 국가 등)
        - CII 점수 기반 필터링 및 정렬
        - 페이지네이션 지원
        - 15분 캐싱 (동일 검색 파라미터)

        ## Quota Cost
        - 100 units (캐시 미스 시)
        - 0 units (캐시 히트 시)

      operationId: searchYouTubeVideos
      parameters:
        - name: q
          in: query
          required: true
          description: 검색 키워드
          schema:
            type: string
            minLength: 1
            maxLength: 200
          example: "react tutorial"

        - name: videoType
          in: query
          description: 영상 타입 필터
          schema:
            type: string
            enum: [shorts, long-form, all]
            default: all
          example: "all"

        - name: publishedAfter
          in: query
          description: 업로드 기간 시작 (ISO 8601)
          schema:
            type: string
            format: date-time
          example: "2025-01-01T00:00:00Z"

        - name: publishedBefore
          in: query
          description: 업로드 기간 종료 (ISO 8601)
          schema:
            type: string
            format: date-time
          example: "2025-01-15T23:59:59Z"

        - name: regionCode
          in: query
          description: 국가 코드 (ISO 3166-1 alpha-2)
          schema:
            type: string
            pattern: ^[A-Z]{2}$
            default: KR
          example: "KR"

        - name: order
          in: query
          description: 정렬 기준
          schema:
            type: string
            enum: [relevance, viewCount, date, rating, cii]
            default: relevance
          example: "viewCount"

        - name: channelId
          in: query
          description: 특정 채널 필터 (선택)
          schema:
            type: string
          example: "UC_x5XG1OV2P6uZZ5FSM9Ttw"

        - name: maxResults
          in: query
          description: 영상 수집 수
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 25
          example: 25

        - name: pageToken
          in: query
          description: 페이지네이션 토큰
          schema:
            type: string
          example: "CAUQAA"

        - name: minViewCount
          in: query
          description: 최소 조회수 필터
          schema:
            type: integer
            minimum: 0
          example: 100000

        - name: minSubscribers
          in: query
          description: 최소 구독자 수 필터
          schema:
            type: integer
            minimum: 0
          example: 10000

        - name: minCiiScore
          in: query
          description: 최소 CII 점수 (0-100)
          schema:
            type: number
            minimum: 0
            maximum: 100
          example: 70

        - name: maxCiiScore
          in: query
          description: 최대 CII 점수 (0-100)
          schema:
            type: number
            minimum: 0
            maximum: 100
          example: 100

      responses:
        '200':
          description: 검색 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

        '400':
          description: 잘못된 요청 파라미터
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidKeyword:
                  value:
                    error:
                      code: INVALID_PARAMETER
                      message: "검색어는 1자 이상이어야 합니다"

        '403':
          description: Quota 초과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                quotaExceeded:
                  value:
                    error:
                      code: QUOTA_EXCEEDED
                      message: "일일 검색 한도를 초과했습니다. 내일 다시 시도해주세요."

        '429':
          description: Rate limit 초과
          headers:
            Retry-After:
              description: 재시도 가능 시간 (초)
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                rateLimitExceeded:
                  value:
                    error:
                      code: RATE_LIMIT_EXCEEDED
                      message: "60초 후 다시 시도해주세요."

      security:
        - BearerAuth: []

  /youtube/videos/{videoId}:
    get:
      tags:
        - Videos
      summary: 영상 상세 정보 조회
      description: |
        특정 영상의 상세 정보를 조회합니다.

        ## Quota Cost
        - 1 unit (영상 정보)
        - +50 units (자막 목록 포함 시)

      operationId: getVideoDetails
      parameters:
        - name: videoId
          in: path
          required: true
          description: YouTube 영상 ID
          schema:
            type: string
            pattern: ^[a-zA-Z0-9_-]{11}$
          example: "dQw4w9WgXcQ"

        - name: includeCaptions
          in: query
          description: 자막 정보 포함 여부
          schema:
            type: boolean
            default: false
          example: true

      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/YouTubeSearchResult'

        '404':
          description: 영상을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                videoNotFound:
                  value:
                    error:
                      code: VIDEO_NOT_FOUND
                      message: "영상을 찾을 수 없습니다: dQw4w9WgXcQ"

      security:
        - BearerAuth: []

  /youtube/videos/{videoId}/captions:
    get:
      tags:
        - Videos
      summary: 사용 가능한 자막 목록 조회
      description: |
        영상에서 사용 가능한 자막 언어 목록을 조회합니다.

        ## Quota Cost
        - 50 units (캐시 미스 시)
        - 24시간 캐싱

      operationId: listCaptions
      parameters:
        - name: videoId
          in: path
          required: true
          description: YouTube 영상 ID
          schema:
            type: string
            pattern: ^[a-zA-Z0-9_-]{11}$
          example: "dQw4w9WgXcQ"

      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CaptionTrack'

        '404':
          description: 자막이 없는 영상
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                noCaptions:
                  value:
                    error:
                      code: CAPTIONS_NOT_AVAILABLE
                      message: "이 영상에는 자막이 없습니다"

      security:
        - BearerAuth: []

  /youtube/videos/{videoId}/captions/{language}:
    get:
      tags:
        - Videos
      summary: 특정 언어 자막 다운로드
      description: |
        특정 언어의 자막 데이터를 다운로드합니다.

        ## Quota Cost
        - 200 units (캐시 미스 시)
        - 24시간 캐싱

      operationId: downloadCaption
      parameters:
        - name: videoId
          in: path
          required: true
          description: YouTube 영상 ID
          schema:
            type: string
            pattern: ^[a-zA-Z0-9_-]{11}$
          example: "dQw4w9WgXcQ"

        - name: language
          in: path
          required: true
          description: 언어 코드 (ISO 639-1)
          schema:
            type: string
            pattern: ^[a-z]{2}$
          example: "ko"

      responses:
        '200':
          description: 다운로드 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaptionData'

        '404':
          description: 자막을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                captionNotFound:
                  value:
                    error:
                      code: CAPTION_NOT_FOUND
                      message: "해당 언어의 자막을 찾을 수 없습니다: ko"

      security:
        - BearerAuth: []

  /youtube/channels/{channelId}/cii:
    get:
      tags:
        - Channels
      summary: 채널 CII (영향력 지수) 계산
      description: |
        채널의 영향력 지수를 계산합니다.

        ## CII 계산 요소
        - 구독자 수 (40% 가중치)
        - 평균 조회수 (30% 가중치, 최근 10개 영상)
        - 영상 게시 빈도 (15% 가중치, 월평균)
        - 평균 좋아요 비율 (15% 가중치)

        ## Quota Cost
        - 3 units (채널 정보 + 재생목록 + 영상 상세)
        - 6시간 캐싱

      operationId: calculateChannelCII
      parameters:
        - name: channelId
          in: path
          required: true
          description: YouTube 채널 ID
          schema:
            type: string
          example: "UC_x5XG1OV2P6uZZ5FSM9Ttw"

      responses:
        '200':
          description: 계산 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CIIMetrics'

        '404':
          description: 채널을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                channelNotFound:
                  value:
                    error:
                      code: CHANNEL_NOT_FOUND
                      message: "채널을 찾을 수 없습니다"

      security:
        - BearerAuth: []

  /templates/from-youtube:
    post:
      tags:
        - Templates
      summary: YouTube 영상을 템플릿으로 저장
      description: |
        검색한 YouTube 영상을 템플릿으로 저장합니다.

        ## 저장 데이터
        - 영상 메타데이터 (제목, 설명, 태그, 통계 등)
        - CII 점수 및 채널 정보
        - 선택한 언어의 자막 데이터 (선택 사항)

        ## Quota Cost
        - 1 unit (영상 정보)
        - +50 units (자막 목록, includeCaptions=true 시)
        - +200 units per language (자막 다운로드)

      operationId: saveYouTubeTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveYouTubeTemplateRequest'
            examples:
              withoutCaptions:
                summary: 자막 없이 저장
                value:
                  videoId: "dQw4w9WgXcQ"
                  name: "React Tutorial Template"
                  category: "education"
                  includeCaptions: false

              withCaptions:
                summary: 자막 포함 저장
                value:
                  videoId: "dQw4w9WgXcQ"
                  name: "React Tutorial Template"
                  category: "education"
                  includeCaptions: true
                  captionLanguages: ["ko", "en"]

      responses:
        '201':
          description: 템플릿 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'

        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidVideoId:
                  value:
                    error:
                      code: INVALID_VIDEO_ID
                      message: "잘못된 YouTube 영상 ID 형식입니다"

        '404':
          description: 영상을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

      security:
        - BearerAuth: []

  /youtube/search-history:
    get:
      tags:
        - History
      summary: 검색 히스토리 조회
      description: |
        최근 10개 검색어를 조회합니다.

        ## 정렬
        - 최신 검색어 순으로 정렬

      operationId: getSearchHistory
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SearchHistoryItem'

      security:
        - BearerAuth: []

    post:
      tags:
        - History
      summary: 검색 히스토리 저장
      description: |
        검색어를 히스토리에 저장합니다.

        ## 자동 정리
        - 최근 10개만 유지
        - 중복 검색어는 갱신

      operationId: saveSearchHistory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchHistoryCreateRequest'
            example:
              keyword: "react tutorial"
              searchParams:
                videoType: "all"
                regionCode: "KR"
                order: "viewCount"

      responses:
        '201':
          description: 저장 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchHistoryItem'

      security:
        - BearerAuth: []

  /youtube/search-history/{keyword}:
    delete:
      tags:
        - History
      summary: 검색 히스토리 삭제
      description: 특정 검색어를 히스토리에서 삭제합니다.
      operationId: deleteSearchHistory
      parameters:
        - name: keyword
          in: path
          required: true
          description: 삭제할 검색어
          schema:
            type: string
          example: "react tutorial"

      responses:
        '204':
          description: 삭제 성공

        '404':
          description: 검색어를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

      security:
        - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT 토큰

  schemas:
    ThumbnailSet:
      type: object
      required:
        - default
        - medium
        - high
      properties:
        default:
          type: string
          format: uri
          example: "https://i.ytimg.com/vi/dQw4w9WgXcQ/default.jpg"
        medium:
          type: string
          format: uri
          example: "https://i.ytimg.com/vi/dQw4w9WgXcQ/mqdefault.jpg"
        high:
          type: string
          format: uri
          example: "https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg"
        standard:
          type: string
          format: uri
          example: "https://i.ytimg.com/vi/dQw4w9WgXcQ/sddefault.jpg"
        maxres:
          type: string
          format: uri
          example: "https://i.ytimg.com/vi/dQw4w9WgXcQ/maxresdefault.jpg"

    YouTubeSearchResult:
      type: object
      required:
        - videoId
        - title
        - description
        - thumbnails
        - channelId
        - channelTitle
        - publishedAt
        - viewCount
        - duration
        - videoType
        - captionsAvailable
      properties:
        videoId:
          type: string
          pattern: ^[a-zA-Z0-9_-]{11}$
          example: "dQw4w9WgXcQ"
        title:
          type: string
          example: "Sample Video Title"
        description:
          type: string
          example: "This is a sample video description"
        thumbnails:
          $ref: '#/components/schemas/ThumbnailSet'
        channelId:
          type: string
          example: "UC_x5XG1OV2P6uZZ5FSM9Ttw"
        channelTitle:
          type: string
          example: "Sample Channel"
        channelSubscriberCount:
          type: integer
          minimum: 0
          example: 1000000
        publishedAt:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        viewCount:
          type: integer
          minimum: 0
          example: 1000000
        likeCount:
          type: integer
          minimum: 0
          example: 50000
        duration:
          type: string
          description: ISO 8601 duration (e.g., PT1M30S)
          pattern: ^PT(?:\d+H)?(?:\d+M)?(?:\d+S)?$
          example: "PT3M33S"
        videoType:
          type: string
          enum: [shorts, long-form]
          example: "long-form"
        tags:
          type: array
          items:
            type: string
          example: ["music", "pop", "80s"]
        categoryId:
          type: string
          example: "10"
        captionsAvailable:
          type: boolean
          example: true
        availableCaptions:
          type: array
          items:
            type: string
          example: ["ko", "en", "ja"]
        ciiScore:
          type: number
          minimum: 0
          maximum: 100
          example: 75.5

    SearchResponse:
      type: object
      required:
        - items
        - totalResults
        - resultsPerPage
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/YouTubeSearchResult'
        nextPageToken:
          type: string
          example: "CAUQAA"
        prevPageToken:
          type: string
          example: "CAEQAQ"
        totalResults:
          type: integer
          minimum: 0
          example: 1000
        resultsPerPage:
          type: integer
          minimum: 1
          maximum: 50
          example: 25

    CaptionTrack:
      type: object
      required:
        - language
        - languageName
        - isAutoGenerated
        - captionId
      properties:
        language:
          type: string
          pattern: ^[a-z]{2}$
          description: 언어 코드 (ISO 639-1)
          example: "ko"
        languageName:
          type: string
          example: "한국어"
        isAutoGenerated:
          type: boolean
          description: 자동 생성 자막 여부
          example: false
        captionId:
          type: string
          example: "SwPOvp0r7kd9ttt_XhcHdZthNwSopnhhb1iMWv6HbWQ="

    Caption:
      type: object
      required:
        - text
        - start
        - duration
      properties:
        text:
          type: string
          example: "안녕하세요"
        start:
          type: number
          format: float
          minimum: 0
          description: 시작 시간 (초)
          example: 0.0
        duration:
          type: number
          format: float
          minimum: 0
          description: 지속 시간 (초)
          example: 2.5

    CaptionData:
      type: object
      required:
        - videoId
        - language
        - languageName
        - isAutoGenerated
        - captions
        - fullText
      properties:
        videoId:
          type: string
          pattern: ^[a-zA-Z0-9_-]{11}$
          example: "dQw4w9WgXcQ"
        language:
          type: string
          pattern: ^[a-z]{2}$
          example: "ko"
        languageName:
          type: string
          example: "한국어"
        isAutoGenerated:
          type: boolean
          example: false
        captions:
          type: array
          items:
            $ref: '#/components/schemas/Caption'
        fullText:
          type: string
          description: 타임스탬프 제거한 전체 자막 텍스트
          example: "안녕하세요 오늘은 YouTube 검색에 대해 알아보겠습니다"

    CIIMetrics:
      type: object
      required:
        - channelId
        - channelTitle
        - subscriberCount
        - averageViewCount
        - uploadFrequency
        - averageLikeRatio
        - ciiScore
      properties:
        channelId:
          type: string
          example: "UC_x5XG1OV2P6uZZ5FSM9Ttw"
        channelTitle:
          type: string
          example: "Sample Channel"
        subscriberCount:
          type: integer
          minimum: 0
          description: 구독자 수
          example: 1000000
        averageViewCount:
          type: number
          format: float
          minimum: 0
          description: 평균 조회수 (최근 10개 영상)
          example: 500000.0
        uploadFrequency:
          type: number
          format: float
          minimum: 0
          description: 영상 게시 빈도 (월평균)
          example: 8.5
        averageLikeRatio:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: 평균 좋아요 비율 (0-1)
          example: 0.035
        ciiScore:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: 최종 CII 점수 (0-100)
          example: 75.5

    SaveYouTubeTemplateRequest:
      type: object
      required:
        - videoId
        - name
        - category
      properties:
        videoId:
          type: string
          pattern: ^[a-zA-Z0-9_-]{11}$
          description: YouTube 영상 ID
          example: "dQw4w9WgXcQ"
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 템플릿 이름
          example: "React Tutorial Template"
        category:
          type: string
          description: 템플릿 카테고리
          example: "education"
        includeCaptions:
          type: boolean
          default: false
          description: 자막 포함 여부
          example: false
        captionLanguages:
          type: array
          items:
            type: string
            pattern: ^[a-z]{2}$
          description: 포함할 자막 언어 코드 목록
          example: ["ko", "en"]

    Template:
      type: object
      required:
        - id
        - name
        - category
        - userId
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          example: "React Tutorial Template"
        category:
          type: string
          example: "education"
        userId:
          type: string
          format: uuid
          example: "987e6543-e21b-98d7-b654-321456789abc"
        youtubeVideoId:
          type: string
          pattern: ^[a-zA-Z0-9_-]{11}$
          example: "dQw4w9WgXcQ"
        youtubeMetadata:
          type: object
          description: YouTube 영상 메타데이터 (JSONB)
        captions:
          type: object
          description: 언어별 자막 데이터 (JSONB)
        ciiScore:
          type: number
          format: float
          minimum: 0
          maximum: 100
          example: 75.5
        channelInfo:
          type: object
          description: 채널 정보 (JSONB)
        createdAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    SearchHistoryItem:
      type: object
      required:
        - id
        - keyword
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        keyword:
          type: string
          example: "react tutorial"
        searchParams:
          type: object
          description: 검색 시 사용한 필터 파라미터
          example:
            videoType: "all"
            regionCode: "KR"
            order: "viewCount"
        createdAt:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    SearchHistoryCreateRequest:
      type: object
      required:
        - keyword
      properties:
        keyword:
          type: string
          minLength: 1
          maxLength: 200
          example: "react tutorial"
        searchParams:
          type: object
          description: 검색 시 사용한 필터 파라미터
          example:
            videoType: "all"
            regionCode: "KR"
            order: "viewCount"

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum:
                - INVALID_PARAMETER
                - QUOTA_EXCEEDED
                - RATE_LIMIT_EXCEEDED
                - VIDEO_NOT_FOUND
                - CHANNEL_NOT_FOUND
                - CAPTION_NOT_FOUND
                - CAPTIONS_NOT_AVAILABLE
                - INVALID_VIDEO_ID
                - INTERNAL_SERVER_ERROR
              example: "QUOTA_EXCEEDED"
            message:
              type: string
              example: "일일 검색 한도를 초과했습니다. 내일 다시 시도해주세요."
