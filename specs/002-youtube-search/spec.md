# YouTube 영상 검색 기능 명세서

## 개요

ClipPilot에 YouTube 영상 검색 및 선택 기능을 추가하여 사용자가 템플릿으로 사용할 영상을 검색하고 선택할 수 있도록 합니다.

## 목표

- YouTube Data API v3를 활용한 영상 검색 기능
- 검색 결과를 그리드/리스트 형태로 표시
- 영상 정보 (썸네일, 제목, 채널명, 조회수, 게시일 등) 표시
- 영상 선택 및 템플릿 저장 기능

## 참고 이미지

`img/tube.png` - 유튜브 영상 검색 인터페이스 디자인 참고

## 기능 요구사항

### FR-001: YouTube 영상 검색
- **설명**: 사용자가 키워드로 YouTube 영상을 검색할 수 있어야 합니다.
- **입력**:
  - 검색 키워드 (string)
  - 영상 수집 수 (기본값: 25개, 최대: 50개)
- **출력**: 검색 결과 목록
- **제약사항**:
  - YouTube Data API v3 사용
  - 검색어는 1자 이상이어야 함
  - 결과는 관련도 순으로 정렬 (정렬 기준 변경 가능)
  - 사용자가 지정한 수집 수만큼 결과 반환

### FR-002: 검색 필터
- **설명**: 검색 결과를 필터링할 수 있어야 합니다.
- **필터 옵션**:
  - **영상 타입**:
    - 쇼츠 (Shorts, 60초 이하)
    - 롱폼 (Long-form, 60초 초과)
    - 쇼츠+롱폼 (모든 타입)
  - **업로드 기간**:
    - 1시간 이내
    - 오늘 (24시간 이내)
    - 이번주 (7일 이내)
    - 이번달 (30일 이내)
    - 올해 (365일 이내)
    - 사용자 지정 (특정 날짜 범위)
  - **국가/지역**:
    - 한국 (KR)
    - 일본 (JP)
    - 미국 (US)
    - 기타 주요 국가 (영국, 독일, 프랑스, 중국 등)
  - **채널 지표**:
    - CII (Channel Influence Index) 범위 필터
    - 조회수 최소값
    - 구독자 수 최소값
  - **정렬 기준**:
    - 관련도 (relevance)
    - 조회수 (viewCount)
    - 업로드 날짜 (date)
    - 평점 (rating)
    - CII 점수 (높은 순)

### FR-003: 영상 정보 표시
- **설명**: 각 검색 결과에 영상 정보를 표시해야 합니다.
- **표시 정보**:
  - 썸네일 이미지 (고화질)
  - 영상 제목
  - 채널명
  - 조회수
  - 게시일
  - 영상 길이
  - 영상 타입 표시 (쇼츠/롱폼)
  - 좋아요/구독자 수
  - CII (Channel Influence Index) 점수
  - 자막 가용 여부 표시

### FR-004: 영상 미리보기
- **설명**: 영상을 선택하면 상세 정보와 미리보기를 볼 수 있어야 합니다.
- **미리보기 정보**:
  - 임베디드 플레이어
  - 전체 설명 (description)
  - 태그
  - 카테고리
  - 댓글 수
  - 사용 가능한 자막 언어 목록
  - 채널 상세 정보 (구독자 수, CII 점수)

### FR-005: 영상 선택 및 저장
- **설명**: 검색한 영상을 템플릿으로 저장할 수 있어야 합니다.
- **저장 정보**:
  - YouTube 영상 ID
  - 영상 메타데이터 (제목, 설명, 태그 등)
  - 템플릿 이름 (사용자 지정)
  - 템플릿 카테고리
  - 수집한 자막 데이터 (언어별)
  - CII 점수 및 채널 정보

### FR-006: 검색 히스토리
- **설명**: 최근 검색어를 저장하고 다시 검색할 수 있어야 합니다.
- **기능**:
  - 최근 10개 검색어 저장
  - 검색어 클릭으로 재검색
  - 검색어 삭제 기능

### FR-007: 자막 수집
- **설명**: 선택한 영상의 자막을 수집하여 저장할 수 있어야 합니다.
- **기능**:
  - 사용 가능한 자막 언어 목록 표시
  - 자동 생성 자막 및 수동 자막 구분 표시
  - 선택한 언어의 자막 텍스트 추출
  - 자막 타임스탬프 정보 포함
  - 자막을 템플릿 메타데이터에 포함하여 저장
- **제약사항**:
  - 자막이 없는 영상의 경우 사용자에게 안내
  - YouTube Data API v3의 captions 리소스 사용

### FR-008: CII (Channel Influence Index) 계산 및 필터링
- **설명**: 채널의 영향력 지수를 계산하여 검색 결과 필터링 및 정렬에 활용합니다.
- **CII 계산 요소**:
  - 구독자 수 (40% 가중치)
  - 평균 조회수 (30% 가중치)
  - 영상 게시 빈도 (15% 가중치)
  - 평균 좋아요 비율 (15% 가중치)
- **기능**:
  - 각 채널의 CII 점수 자동 계산
  - CII 점수 범위 필터 (예: 70점 이상만 표시)
  - CII 점수로 검색 결과 정렬
  - 검색 결과에 CII 점수 표시 (선택 사항)

## 비기능 요구사항

### NFR-001: 성능
- 검색 API 응답 시간: 2초 이내
- 썸네일 로딩: Progressive loading 적용
- 무한 스크롤 지원 (페이지네이션)

### NFR-002: API Quota 관리
- YouTube Data API v3 일일 quota: 10,000 units
- 검색당 100 units 소비
- 영상 상세 조회당 1 unit 소비
- 자막 목록 조회당 50 units 소비
- 자막 다운로드당 200 units 소비
- CII 계산 시 채널 정보 조회당 1 unit 소비
- 일일 최대 사용량 관리 및 모니터링
- Quota 초과 시 사용자에게 안내 메시지 및 대기 시간 표시

### NFR-003: 캐싱
- 검색 결과 캐싱 (15분)
- 영상 메타데이터 캐싱 (1시간)
- 자막 데이터 캐싱 (24시간)
- CII 점수 캐싱 (6시간)
- Redis 활용

### NFR-004: UI/UX
- 반응형 디자인 (모바일, 태블릿, 데스크톱)
- 스켈레톤 로딩 UI
- 에러 상태 처리 (네트워크 오류, API 오류 등)

## 데이터 모델

### YouTube Video Search Result
```typescript
interface YouTubeSearchResult {
  videoId: string;
  title: string;
  description: string;
  thumbnails: {
    default: string;
    medium: string;
    high: string;
  };
  channelId: string;
  channelTitle: string;
  channelSubscriberCount: number;
  publishedAt: string;
  viewCount: number;
  likeCount: number;
  duration: string;
  videoType: 'shorts' | 'long-form'; // 60초 기준
  tags?: string[];
  categoryId?: string;
  captionsAvailable: boolean;
  availableCaptions?: string[]; // 사용 가능한 자막 언어 코드 목록
  ciiScore?: number; // Channel Influence Index (0-100)
}
```

### Search Query
```typescript
interface SearchQuery {
  keyword: string;
  videoType?: 'shorts' | 'long-form' | 'all'; // 영상 타입 필터
  publishedAfter?: Date; // 업로드 기간 시작
  publishedBefore?: Date; // 업로드 기간 종료
  regionCode?: string; // 국가 코드 (KR, JP, US 등)
  order?: 'relevance' | 'viewCount' | 'date' | 'rating' | 'cii'; // 정렬 기준
  channelId?: string;
  maxResults?: number; // 영상 수집 수 (default: 25, max: 50)
  minViewCount?: number; // 최소 조회수
  minSubscribers?: number; // 최소 구독자 수
  minCiiScore?: number; // 최소 CII 점수 (0-100)
  maxCiiScore?: number; // 최대 CII 점수 (0-100)
}
```

### Caption Data
```typescript
interface CaptionTrack {
  language: string; // 언어 코드 (ko, en, ja 등)
  languageName: string; // 언어 이름 (한국어, English, 日本語)
  isAutoGenerated: boolean; // 자동 생성 자막 여부
  captionId: string; // YouTube 자막 ID
}

interface Caption {
  text: string; // 자막 텍스트
  start: number; // 시작 시간 (초)
  duration: number; // 지속 시간 (초)
}

interface CaptionData {
  videoId: string;
  language: string;
  captions: Caption[]; // 타임스탬프 포함 자막 배열
  fullText: string; // 전체 자막 텍스트 (타임스탬프 제거)
}
```

### Channel Influence Index (CII)
```typescript
interface CIIMetrics {
  subscriberCount: number; // 구독자 수
  averageViewCount: number; // 평균 조회수 (최근 10개 영상)
  uploadFrequency: number; // 영상 게시 빈도 (월평균)
  averageLikeRatio: number; // 평균 좋아요 비율 (좋아요/조회수)
  ciiScore: number; // 최종 CII 점수 (0-100)
}
```

### Template from YouTube
```sql
-- templates 테이블에 youtube_video_id 컬럼 추가
ALTER TABLE templates ADD COLUMN youtube_video_id VARCHAR(20);
ALTER TABLE templates ADD COLUMN youtube_metadata JSONB;
ALTER TABLE templates ADD COLUMN captions JSONB; -- 자막 데이터 저장
ALTER TABLE templates ADD COLUMN cii_score DECIMAL(5,2); -- CII 점수 (0-100)
ALTER TABLE templates ADD COLUMN channel_info JSONB; -- 채널 정보 (구독자 수 등)
```

## API 엔드포인트

### 1. YouTube 영상 검색
```
GET /api/v1/youtube/search
Query Parameters:
  - q: string (required) - 검색 키워드
  - videoType: shorts|long-form|all (optional, default: all) - 영상 타입
  - publishedAfter: ISO 8601 date (optional) - 업로드 기간 시작
  - publishedBefore: ISO 8601 date (optional) - 업로드 기간 종료
  - regionCode: string (optional, default: KR) - 국가 코드 (KR, JP, US 등)
  - order: relevance|viewCount|date|rating|cii (optional, default: relevance)
  - channelId: string (optional)
  - pageToken: string (optional) - 페이지네이션
  - maxResults: number (optional, default: 25, max: 50) - 영상 수집 수
  - minViewCount: number (optional) - 최소 조회수 필터
  - minSubscribers: number (optional) - 최소 구독자 수 필터
  - minCiiScore: number (optional, 0-100) - 최소 CII 점수 필터
  - maxCiiScore: number (optional, 0-100) - 최대 CII 점수 필터

Response:
{
  "items": [...YouTubeSearchResult],
  "nextPageToken": "string",
  "prevPageToken": "string",
  "totalResults": number
}
```

### 2. 영상 상세 정보
```
GET /api/v1/youtube/videos/{videoId}
Query Parameters:
  - includeCaptions: boolean (optional, default: false) - 자막 정보 포함 여부

Response: YouTubeSearchResult (+ CaptionTrack[] if includeCaptions=true)
```

### 3. 영상 자막 조회
```
GET /api/v1/youtube/videos/{videoId}/captions
Response: CaptionTrack[]

GET /api/v1/youtube/videos/{videoId}/captions/{language}
Response: CaptionData
```

### 4. 채널 CII 계산
```
GET /api/v1/youtube/channels/{channelId}/cii
Response: CIIMetrics
```

### 5. 템플릿으로 저장
```
POST /api/v1/templates/from-youtube
Body:
{
  "videoId": "string",
  "name": "string",
  "category": "string",
  "includeCaptions": boolean (optional, default: false),
  "captionLanguages": string[] (optional) - 포함할 자막 언어 코드
}

Response: Template (with captions and CII data)
```

### 6. 검색 히스토리
```
GET /api/v1/youtube/search-history
Response: string[]

POST /api/v1/youtube/search-history
Body: { "keyword": "string" }

DELETE /api/v1/youtube/search-history/{keyword}
```

## UI 컴포넌트 구조

```
VideoSearchPage
├── SearchBar
│   ├── SearchInput
│   ├── CollectionCountSelector (영상 수집 수 선택)
│   └── SearchFilters
│       ├── VideoTypeFilter (쇼츠/롱폼/전체)
│       ├── UploadPeriodFilter (업로드 기간)
│       ├── RegionSelector (국가 선택)
│       ├── ViewCountFilter (조회수 필터)
│       ├── SubscriberFilter (구독자 수 필터)
│       └── CIIFilter (CII 점수 범위)
├── SearchHistory
├── VideoGrid
│   └── VideoCard (repeat)
│       ├── Thumbnail
│       ├── VideoTypeBadge (쇼츠/롱폼 표시)
│       ├── VideoInfo
│       │   ├── Title
│       │   ├── ChannelName
│       │   ├── ViewCount
│       │   ├── PublishedDate
│       │   ├── CIIScore (점수 표시)
│       │   └── CaptionsBadge (자막 가용 여부)
│       └── SelectButton
└── VideoDetailModal
    ├── VideoPlayer
    ├── VideoMetadata
    │   ├── Description
    │   ├── Tags
    │   ├── Category
    │   └── ChannelDetails (구독자 수, CII 점수)
    ├── CaptionsSelector
    │   ├── AvailableLanguages
    │   └── CaptionPreview
    └── SaveAsTemplateForm
        ├── TemplateName
        ├── Category
        └── CaptionOptions (포함할 자막 언어 선택)
```

## 구현 우선순위

### Phase 1: 기본 검색 및 필터링 (P0)
- [ ] YouTube Data API v3 연동
- [ ] 기본 검색 API 엔드포인트
- [ ] 영상 타입 필터 (쇼츠/롱폼/전체)
- [ ] 업로드 기간 필터
- [ ] 국가/지역 선택
- [ ] 영상 수집 수 설정
- [ ] 검색 결과 표시 UI

### Phase 2: 고급 필터 & CII (P0)
- [ ] CII (Channel Influence Index) 계산 로직
- [ ] CII 점수 필터링
- [ ] 조회수 필터
- [ ] 구독자 수 필터
- [ ] 검색 결과에 CII 점수 표시

### Phase 3: 자막 수집 (P1)
- [ ] 자막 목록 조회 API
- [ ] 자막 다운로드 및 파싱
- [ ] 자막 언어 선택 UI
- [ ] 자막 미리보기 기능
- [ ] 템플릿 저장 시 자막 포함

### Phase 4: 영상 미리보기 & 저장 (P1)
- [ ] 영상 상세 모달
- [ ] 임베디드 플레이어
- [ ] 자막 정보 표시
- [ ] 템플릿으로 저장 기능

### Phase 5: 최적화 & 부가 기능 (P2)
- [ ] 검색 결과 캐싱
- [ ] 무한 스크롤
- [ ] 검색 히스토리
- [ ] API Quota 모니터링 대시보드

## 기술 스택

### Backend
- **API**: YouTube Data API v3
- **캐싱**: Redis
- **프레임워크**: FastAPI

### Frontend
- **프레임워크**: Next.js 14
- **UI 라이브러리**: shadcn/ui
- **상태 관리**: TanStack Query
- **YouTube 플레이어**: react-youtube

## 보안 고려사항

1. **API 키 관리**
   - YouTube API 키는 환경 변수로 관리
   - 백엔드에서만 API 호출 (프론트엔드 노출 방지)

2. **Rate Limiting**
   - 사용자당 분당 최대 10회 검색
   - IP 기반 제한 추가

3. **입력 검증**
   - 검색어 XSS 방지
   - SQL Injection 방지 (ORM 사용)

## 테스트 계획

### 단위 테스트
- YouTube API 서비스 함수 테스트
- 검색 필터 로직 테스트
- 캐싱 로직 테스트

### 통합 테스트
- API 엔드포인트 E2E 테스트
- YouTube API 연동 테스트 (Mock)

### UI 테스트
- Playwright E2E 테스트
- 검색 플로우 테스트
- 영상 선택 및 저장 테스트

## 참고 자료

- [YouTube Data API v3 Documentation](https://developers.google.com/youtube/v3/docs)
- [YouTube Data API - Search](https://developers.google.com/youtube/v3/docs/search/list)
- [YouTube Data API - Videos](https://developers.google.com/youtube/v3/docs/videos/list)
- [YouTube Data API - Channels](https://developers.google.com/youtube/v3/docs/channels/list)
- [YouTube Data API - Captions](https://developers.google.com/youtube/v3/docs/captions)
- [YouTube Data API Quota Calculator](https://developers.google.com/youtube/v3/determine_quota_cost)
- [react-youtube](https://github.com/tjallingt/react-youtube)
- [ISO 3166-1 Country Codes](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2) - 국가 코드 참고
- [ISO 639-1 Language Codes](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes) - 언어 코드 참고

## 추가 고려사항

### CII (Channel Influence Index) 상세 계산식
```
CII Score = (
  (구독자 수 정규화 점수 × 0.40) +
  (평균 조회수 정규화 점수 × 0.30) +
  (영상 게시 빈도 정규화 점수 × 0.15) +
  (평균 좋아요 비율 정규화 점수 × 0.15)
) × 100

각 지표는 0-1 범위로 정규화:
- 구독자 수: log10(subscribers) / log10(10,000,000) (1천만 구독자 기준)
- 평균 조회수: log10(avg_views) / log10(1,000,000) (100만 조회수 기준)
- 게시 빈도: min(videos_per_month / 10, 1) (월 10개 기준)
- 좋아요 비율: min(avg_like_ratio / 0.05, 1) (5% 기준)
```

### 자막 수집 시 주의사항
- YouTube Data API의 captions 리소스는 OAuth 인증이 필요할 수 있음
- 자동 생성 자막의 정확도는 언어 및 영상 품질에 따라 다름
- 자막 다운로드는 API Quota를 많이 소비하므로 캐싱 필수
- 저작권이 있는 자막의 경우 사용 제한이 있을 수 있음

### YouTube Shorts 판별 기준
- 영상 길이 60초 이하
- YouTube API에서는 duration을 ISO 8601 형식으로 반환 (예: PT1M30S = 1분 30초)
- duration 파싱 후 초 단위로 변환하여 60초 기준으로 판별

### 국가/지역 필터링
- YouTube Data API의 regionCode 파라미터 활용
- 검색 결과는 해당 국가에서 인기 있는 콘텐츠 우선 표시
- 일부 영상은 지역 제한으로 특정 국가에서 접근 불가능할 수 있음
